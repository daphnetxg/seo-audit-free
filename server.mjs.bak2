import express from "express";
import fs from "node:fs";
import path from "node:path";
import { nanoid } from "nanoid";
import { auditHomepage } from "./audit.mjs";

const app = express();
app.use(express.json({ limit: "1mb" }));
app.use(express.urlencoded({ extended: false }));

const OUTPUT_DIR = path.resolve("./output");
fs.mkdirSync(OUTPUT_DIR, { recursive: true });
app.use("/r", express.static(OUTPUT_DIR));

function esc(s) {
  return String(s || "")
    .replaceAll("&", "&amp;")
    .replaceAll("<", "&lt;")
    .replaceAll(">", "&gt;")
    .replaceAll('"', "&quot;");
}

function statusFromSignals(signals = []) {
  const hasHigh = signals.some((x) => x.level === "high");
  const hasMed = signals.some((x) => x.level === "med");
  if (hasHigh) return { icon: "âŒ", text: "å­˜åœ¨é«˜é£é™©ä¿¡å·ï¼Œå»ºè®®å°½å¿«è¿›ä¸€æ­¥æ£€æŸ¥", tone: "bad" };
  if (hasMed) return { icon: "âš ï¸", text: "å­˜åœ¨ä¸­åº¦é£é™©ï¼Œå¯èƒ½å½±å“æ”¶å½•æˆ–ç‚¹å‡»ç‡", tone: "warn" };
  return { icon: "âœ…", text: "å½“å‰æœªå‘ç°æ˜æ˜¾è‡´å‘½é—®é¢˜", tone: "good" };
}

function businessTranslationSignals(model) {
  // æŠŠâ€œæŠ€æœ¯é¡¹â€ç¿»è¯‘æˆâ€œå•†ä¸šåæœâ€ï¼Œåªè¾“å‡ºæ˜ç¡®ã€ç›´è§‚ã€ä¸ä¼šè¿‡åº¦æ‰¿è¯ºçš„è¯­å¥
  const out = [];

  // Meta description
  if (model.homepage.meta_desc === "â€”" || model.homepage.meta_desc_len === 0) {
    out.push({
      icon: "âŒ",
      title: "æœªæ£€æµ‹åˆ° Meta Description",
      body: "è¿™æ„å‘³ç€ä½ çš„é¡µé¢åœ¨æœç´¢ç»“æœä¸­ï¼Œç‚¹å‡»ç‡å¯èƒ½æ˜æ˜¾ä½äºåŒç±»ç½‘ç«™ï¼ˆç”¨æˆ·ä¸çŸ¥é“ä½ è¿™é¡µåˆ°åº•åœ¨è®²ä»€ä¹ˆï¼‰ã€‚",
      level: "high"
    });
  }

  // H1
  if (model.homepage.h1_count === 0) {
    out.push({
      icon: "âš ï¸",
      title: "æœªæ£€æµ‹åˆ° H1 æ ‡é¢˜",
      body: "è¿™å¯èƒ½å¯¼è‡´æœç´¢å¼•æ“æ— æ³•å¿«é€ŸæŠ“ä½é¡µé¢ä¸»é¢˜é‡ç‚¹ï¼Œè¿›è€Œå½±å“é¡µé¢ç†è§£ä¸æ’åç¨³å®šæ€§ã€‚",
      level: "med"
    });
  } else if (model.homepage.h1_count > 1) {
    out.push({
      icon: "âš ï¸",
      title: "æ£€æµ‹åˆ°å¤šä¸ª H1 æ ‡é¢˜",
      body: "è¿™å¯èƒ½å¯¼è‡´æœç´¢å¼•æ“æ— æ³•å‡†ç¡®ç†è§£é¡µé¢ä¸»é¢˜é‡ç‚¹ï¼ˆåƒä¸€æœ¬ä¹¦æœ‰å¤šä¸ªå°é¢æ ‡é¢˜ï¼‰ã€‚",
      level: "med"
    });
  }

  // Schema
  if (!model.homepage.has_schema_ld) {
    out.push({
      icon: "âš ï¸",
      title: "æœªæ£€æµ‹åˆ°ç»“æ„åŒ–æ•°æ®ï¼ˆSchemaï¼‰",
      body: "åœ¨å½“å‰ AI æœç´¢ç¯å¢ƒä¸‹ï¼Œè¿™ä¼šé™ä½ä½ è¢« AI æ‘˜è¦å¼•ç”¨/æ­£ç¡®å½’ç±»çš„æ¦‚ç‡ï¼ˆç³»ç»Ÿæ›´éš¾â€œè¯»æ‡‚ä½ â€ï¼‰ã€‚",
      level: "med"
    });
  }

  // Title
  if (model.homepage.title === "â€”" || model.homepage.title_len === 0) {
    out.push({
      icon: "âŒ",
      title: "æœªæ£€æµ‹åˆ°é¡µé¢ Title",
      body: "è¿™é€šå¸¸ä¼šç›´æ¥å½±å“æ”¶å½•ä¸æ’åå‘ˆç°ï¼ˆæœç´¢å¼•æ“ç¼ºå°‘æœ€å…³é”®çš„é¡µé¢ä¸»é¢˜ä¿¡å·ï¼‰ã€‚",
      level: "high"
    });
  }

  // Canonicalï¼ˆä¸ä½œä¸ºå¼ºæå“ï¼Œåªåšæé†’ï¼‰
  if (model.homepage.canonical === "â€”") {
    out.push({
      icon: "âš ï¸",
      title: "æœªæ£€æµ‹åˆ° Canonical",
      body: "å½“ä½ æœ‰å¤šç‰ˆæœ¬ URLï¼ˆå¸¦å‚æ•°/é‡å¤è·¯å¾„ï¼‰æ—¶ï¼Œå¯èƒ½å¢åŠ é‡å¤æ”¶å½•ä¸æƒé‡åˆ†æ•£é£é™©ã€‚",
      level: "low"
    });
  }

  // å¦‚æœæ²¡æœ‰ä»»ä½•å¯ç¿»è¯‘ä¿¡å·ï¼Œä¹Ÿè¦ç»™â€œä»·å€¼ç»“è®ºâ€
  if (out.length === 0) {
    out.push({
      icon: "âœ…",
      title: "é¦–é¡µæœªå‘ç°æ˜æ˜¾ç»“æ„æ€§ç¼ºé™·",
      body: "ä½†è¿™åªèƒ½è¯´æ˜é¦–é¡µâ€œçœ‹èµ·æ¥æ²¡é—®é¢˜â€ã€‚çœŸæ­£å½±å“è¯¢ç›˜/æ’åçš„ï¼Œé€šå¸¸åœ¨æœåŠ¡é¡µã€æ ç›®é¡µã€æ—§æ–‡ç« ç­‰é¡µé¢ã€‚",
      level: "good"
    });
  }

  // æŒ‰ä¸¥é‡åº¦æ’åºï¼šhigh > med > low > good
  const rank = { high: 0, med: 1, low: 2, good: 3 };
  out.sort((a, b) => (rank[a.level] ?? 9) - (rank[b.level] ?? 9));

  return out;
}

function renderHtml(model) {
  const st = statusFromSignals(model.signals || []);
  const translated = businessTranslationSignals(model);

  const translatedList = translated
    .map(
      (x) => `
      <li class="item">
        <div class="item-top">
          <div class="item-ic">${esc(x.icon)}</div>
          <div class="item-title">${esc(x.title)}</div>
        </div>
        <div class="item-body">${esc(x.body)}</div>
      </li>
    `
    )
    .join("");

  const rawSignals = (model.signals || []).length
    ? (model.signals || [])
        .map((x) => `<li><span class="tag ${esc(x.level)}">${esc(String(x.level).toUpperCase())}</span>${esc(x.hit)}</li>`)
        .join("")
    : `<li><span class="tag good">OK</span>æœªå‘ç°æ˜æ˜¾è‡´å‘½ä¿¡å·ï¼ˆåŸºäºé¦–é¡µå¿«ç…§ï¼‰ã€‚</li>`;

  return `<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å…è´¹ SEO å¿«ç…§æŠ¥å‘Š</title>
<style>
  :root{
    --bg:#0b0b0c; --card:#141416; --bd:#232326;
    --ink:#f5f5f7; --mut:#a1a1aa; --sub:#d4d4d8;
    --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
  }
  body{margin:0;background:var(--bg);color:var(--ink);
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"PingFang SC","Noto Sans SC","Microsoft YaHei",sans-serif;}
  .wrap{max-width:980px;margin:0 auto;padding:28px 18px 60px;}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:18px;padding:18px;margin:14px 0;}
  h1{font-size:20px;margin:6px 0 4px;letter-spacing:.2px}
  .muted{color:var(--mut);font-size:13px;line-height:1.7}
  .url{color:var(--sub);font-size:14px;word-break:break-all;margin-top:8px}
  .badge{display:inline-flex;align-items:center;gap:10px;padding:8px 12px;border:1px solid var(--bd);border-radius:999px;font-size:13px}
  .dot{width:10px;height:10px;border-radius:50%}
  .dot.good{background:var(--good)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
  .top{display:flex;justify-content:space-between;gap:14px;flex-wrap:wrap;align-items:flex-start}
  .title{font-size:18px;margin:0 0 10px}
  .subtitle{color:var(--mut);font-size:13px;margin:0}
  .hr{height:1px;background:var(--bd);margin:12px 0}
  ul{margin:10px 0 0 18px}
  .list{list-style:none;padding:0;margin:12px 0 0}
  .item{border:1px solid #2a2a2e;border-radius:14px;padding:14px 14px;margin:10px 0;background:#101012}
  .item-top{display:flex;align-items:center;gap:10px}
  .item-ic{font-size:16px}
  .item-title{font-weight:800}
  .item-body{color:var(--sub);line-height:1.8;margin-top:8px}
  .tag{display:inline-block;min-width:56px;text-align:center;font-size:12px;padding:3px 8px;border-radius:999px;margin-right:10px;border:1px solid #2a2a2e;color:var(--mut)}
  .tag.high{background:rgba(239,68,68,.12);border-color:rgba(239,68,68,.35);color:#fff}
  .tag.med{background:rgba(245,158,11,.12);border-color:rgba(245,158,11,.35);color:#fff}
  .tag.low{background:rgba(161,161,170,.12);border-color:rgba(161,161,170,.35);color:#fff}
  .tag.good{background:rgba(34,197,94,.12);border-color:rgba(34,197,94,.35);color:#fff}
  .btn{display:inline-block;background:var(--ink);color:var(--bg);text-decoration:none;padding:10px 14px;border-radius:12px;font-weight:900}
  .btn2{display:inline-block;border:1px solid var(--bd);color:var(--ink);text-decoration:none;padding:10px 14px;border-radius:12px;font-weight:800;margin-left:8px}
  code{background:#0e0e10;border:1px solid #2a2a2e;padding:2px 6px;border-radius:8px;color:#e5e7eb}
</style>
</head>
<body>
  <div class="wrap">

    <!-- â‘  é¡¶éƒ¨ï¼šåˆ¤è¯ + ä¸ç¡®å®šæ€§ -->
    <div class="card">
      <div class="top">
        <div>
          <div class="muted">DAPHNETXG Â· å…è´¹ SEO å¿«ç…§æŠ¥å‘Š</div>
          <h1>ä½ çš„ç½‘ç«™å­˜åœ¨ä»¥ä¸‹ SEO é£é™©ä¿¡å·ï¼ˆåŸºäºé¦–é¡µå¿«ç…§ï¼‰</h1>
          <p class="subtitle">æœ¬æŠ¥å‘Šä»…åŸºäºé¦–é¡µè¿›è¡Œ 2 åˆ†é’Ÿå¿«é€Ÿæ£€æµ‹ï¼Œæœªè¿›è¡Œå…¨ç«™æŠ“å–ã€‚</p>
          <div class="url"><strong>æ£€æµ‹ URLï¼š</strong>${esc(model.site.final_url)}</div>
          <div class="muted">æ£€æµ‹æ—¶é—´ï¼š${esc(model.audited_at)} Â· æŠ“å–è€—æ—¶ï¼š${esc(model.site.fetch_ms)}ms Â· çŠ¶æ€ç ï¼š<code>${esc(model.site.status)}</code></div>
        </div>

        <div class="badge">
          <span class="dot ${esc(st.tone)}"></span>
          <span>${esc(st.icon)} ${esc(st.text)}</span>
        </div>
      </div>
      <div class="hr"></div>
      <div class="muted">âš ï¸ æ³¨æ„ï¼šè¿™ä¸æ˜¯â€œå¥½ / ä¸å¥½â€ï¼Œè€Œæ˜¯â€”â€”ä½ ç°åœ¨ä¸ç¡®å®šã€‚é¦–é¡µé€šå¸¸æ˜¯æœ€åƒæ ·çš„é¡µé¢ï¼ŒçœŸæ­£å½±å“æ”¶å½•ä¸è¯¢ç›˜çš„ï¼Œå¾€å¾€è—åœ¨å…¶ä»–é¡µé¢é‡Œã€‚</div>
    </div>

    <!-- â‘¡ æ ¸å¿ƒä»·å€¼åŒºï¼šæŠ€æœ¯é¡¹ -> å•†ä¸šåæœ -->
    <div class="card">
      <div class="title">æˆ‘ä»¬åœ¨é¦–é¡µæ£€æµ‹åˆ°çš„å…³é”®ä¿¡å·</div>
      <ul class="list">
        ${translatedList}
      </ul>
    </div>

    <!-- å¯é€‰ï¼šç»™æ‡‚çš„äººçœ‹åŸå§‹ä¿¡å·ï¼ˆä¸æŠ¢æˆï¼‰ -->
    <div class="card">
      <div class="title">åŸå§‹æ£€æµ‹ä¿¡å·ï¼ˆç»™æ‡‚çš„äººï¼‰</div>
      <ul>${rawSignals}</ul>
      <div class="muted" style="margin-top:10px">robots meta: <code>${esc(model.site.robots_meta)}</code> Â· x-robots-tag: <code>${esc(model.site.x_robots)}</code></div>
    </div>

    <!-- â‘¢ è®¤çŸ¥å¼•å¯¼ï¼šä¸ºä»€ä¹ˆåªçœ‹é¦–é¡µä¸å¤Ÿ -->
    <div class="card">
      <div class="title">ä¸ºä»€ä¹ˆâ€œåªçœ‹é¦–é¡µâ€æ˜¯ä¸å¤Ÿçš„ï¼Ÿ</div>
      <div style="line-height:1.9;color:var(--sub)">
        é¦–é¡µé€šå¸¸æ˜¯ SEO è¡¨ç°<strong>æœ€å¥½çš„é¡µé¢</strong>ã€‚<br/><br/>
        çœŸæ­£å½±å“æ’åä¸è¯¢ç›˜çš„ï¼Œå¾€å¾€æ˜¯ä»¥ä¸‹é¡µé¢ï¼š<br/>
        â€¢ æ ç›®é¡µ / åˆ†ç±»é¡µ<br/>
        â€¢ æœåŠ¡è¯¦æƒ…é¡µ<br/>
        â€¢ æ—§æ–‡ç«  / å†å²å†…å®¹<br/><br/>
        è¿™äº›é¡µé¢æ˜¯å¦å­˜åœ¨å¤§é‡é‡å¤ã€ç¼ºå¤±ã€ç»“æ„æ··ä¹±ï¼Œæ˜¯é¦–é¡µæ£€æµ‹æ— æ³•å‘Šè¯‰ä½ çš„ã€‚<br/><br/>
        <strong>è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå¾ˆå¤šç½‘ç«™ï¼šâ€œé¦–é¡µçœ‹èµ·æ¥æ²¡é—®é¢˜ï¼Œä½†æ•´ä½“ SEO è¡¨ç°å¾ˆå·®â€ã€‚</strong>
      </div>
    </div>

    <!-- â‘£ å‡çº§ï¼šå–çœŸç›¸ï¼Œä¸å–åŠŸèƒ½ -->
    <div class="card">
      <div class="title">å‡çº§åä½ ä¼šå¤šçŸ¥é“ä»€ä¹ˆï¼Ÿ</div>
      <div style="line-height:1.9;color:var(--sub)">
        â€¢ ğŸ” 10 ä¸ªå…³é”®é¡µé¢çš„çœŸå® SEO çŠ¶æ€<br/>
        â€¢ ğŸ“Š å“ªäº›é—®é¢˜æ˜¯â€œå½±å“æœ€å¤§ã€æœ€å€¼å¾—å…ˆä¿®â€çš„<br/>
        â€¢ ğŸ§­ ä½ ç°åœ¨è¯¥å…ˆæ”¹å“ªé‡Œï¼Œè€Œä¸æ˜¯â€œå…¨éƒ¨é‡åšâ€<br/>
        â€¢ ğŸ“„ ä¸€ä»½å¯ç›´æ¥äº¤ç»™æ‰§è¡Œå›¢é˜Ÿçš„ PDF ä¿®å¤æ¸…å•<br/>
      </div>
      <div style="margin-top:14px">
        <a class="btn" href="#" href="https://buy.stripe.com/6oU6oHdnKc5D8wP2ER5os0i" target="_blank">æŸ¥çœ‹å®Œæ•´ 10 é¡µ SEO å®¡è®¡ï¼ˆRM200ï¼‰</a>
        <a class="btn2" href="javascript:window.print()">æ‰“å°</a>
      </div>
      <div class="muted" style="margin-top:10px">æœ¬æœåŠ¡ä¸åŒ…å«äººå·¥å’¨è¯¢ï¼Œä»…æä¾›ç»“æ„åŒ–è¯Šæ–­æŠ¥å‘Šã€‚</div>
    </div>

  </div>
</body>
</html>`;
}

app.get("/", (req, res) => {
  res.type("html").send(`<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>å…è´¹ SEO å¿«ç…§</title>
<style>
  body{font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI","PingFang SC","Noto Sans SC","Microsoft YaHei",sans-serif;padding:24px;max-width:760px;margin:0 auto}
  input,button{font-size:16px}
</style>
</head>
<body>
  <h2>å…è´¹ SEO å¿«ç…§ï¼ˆ2 åˆ†é’Ÿï¼‰</h2>
  <p>è¾“å…¥ç½‘å€ â†’ ç”Ÿæˆä¸€ä»½â€œé¦–é¡µå¿«ç…§æŠ¥å‘Šâ€ï¼ˆHTMLï¼‰ã€‚</p>
  <form id="f">
    <input id="url" placeholder="https://example.com" style="width:100%;padding:10px" />
    <button style="margin-top:10px;padding:10px 14px">ç”ŸæˆæŠ¥å‘Š</button>
  </form>
  <pre id="out" style="margin-top:12px;white-space:pre-wrap"></pre>
<script>
  const f=document.getElementById('f');
  const out=document.getElementById('out');
  f.addEventListener('submit', async (e)=>{
    e.preventDefault();
    out.textContent='æ­£åœ¨æ£€æµ‹...';
    const url=document.getElementById('url').value;
    const r=await fetch('/api/audit-free',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({url})});
    const j=await r.json();
    out.textContent = j.ok ? ('æŠ¥å‘Šé“¾æ¥ï¼š'+ location.origin + j.report_path) : ('é”™è¯¯ï¼š'+j.error);
  });
</script>
</body>
</html>`);
});

app.post("/api/audit-free", async (req, res) => {
  try {
    const { url } = req.body || {};
    const model = await auditHomepage(url);

    const id = nanoid(10);
    const dir = path.join(OUTPUT_DIR, id);
    fs.mkdirSync(dir, { recursive: true });

    fs.writeFileSync(path.join(dir, "report.html"), renderHtml(model), "utf8");
    fs.writeFileSync(path.join(dir, "report.json"), JSON.stringify(model, null, 2), "utf8");

    res.json({ ok: true, report_path: `/r/${id}/report.html` });
  } catch (e) {
    res.status(400).json({ ok: false, error: e.message || String(e) });
  }
});

const PORT = process.env.PORT || 8787;
app.listen(PORT, () => {
  console.log(`Free audit running: http://localhost:${PORT}`);
});
